<!--

Copyright (c) 2011 Pierce Moore, RefreshedWeb.com, and NerdTraining.info
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
Neither the names of Pierce Moore, RefreshedWeb.com, NerdTraining.info,  nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

-->

<html>
<head>
<script type="text/javascript">
	
//var data = parseDatabase();
//var debug = data.dataPrefs.developerMode;
var debug = true;
var lsTable = "bantp";
var defaultData = {
	"info": {
		"name": "Bad Ass New Tab Page",
		"description": "A Google Chrome extension for people tired of Chrome's ugly, useless tab page.",
		"version": "0.1.2",
		"homepage": "http://www.refreshedweb.com/projects/newtab/",
		"github": "http://www.github.com/piercemoore/bantp/",
		"devName": "Pierce Moore",
		"devEmail": "Pierce@RefreshedWeb.com"
	},
	"prefs": {
		"developerMode": true
	},
	"links": {
		"linkCount": 10,
		"links": {
			0: {
				"href": "http://www.facebook.com",
				"name": "facebook"
			},
			1: {
				"href": "http://www.google.com",
				"name": "google"
			},
			2: {
				"href": "http://www.gmail.com",
				"name": "gmail"
			},
			3: {
				"href": "http://www.lifehacker.com",
				"name": "lifehacker"
			},
			4: {
				"href": "http://www.gizmodo.com",
				"name": "gizmodo"
			},
			5: {
				"href": "http://www.newegg.com",
				"name": "newegg"
			},
			6: {
				"href": "http://www.last.fm",
				"name": "last.fm"
			},
			7: {
				"href": "https://www.google.com/calendar/render?tab=mc",
				"name": "google calendar"
			},
			8: {
				"href": "http://www.php.net",
				"name": "php.net"
			},
			9: {
				"href": "http://amazon.com",
				"name": "amazon"
			}
		}
	}
};
var firstInstall = isFirstInstall();
var debug = getDeveloperMode();
log(defaultData);
log(JSON.stringify(defaultData));

function log(msg) {
	if(debug) {
		console.log(msg);
	}
}

function getDeveloperMode() {
	// Sometime soon I will mess with this, but for now it's just going to be true.
	return true;
}


// Now, let's get into some nice, sweet functionality. Do NOT edit below this comment if you do not know what you are doing!

function addLink(title,url) {
	//log("Adding new link: Title- " + title + ", URL- " + url);
	var t = lsTable; // Name of table
	//log(t);
	//log("Grabbing the link Object...");
	// Grab the link object really quickly
	var linkObj = getLinkObj();
	//log(linkObj);
	//log("Grabbing Link List");
	// Now grab the JSON object for the links themselves
	var linkList = linkObj.links;
	//log(linkList);
	//log("Now we're counting the total number of links.");
	// Let's count how many links are in the table so far, so we can insert the new link in the last position.
	var linkCount = countTotalLinks(linkList); // Since this number does not start from 0, we will just use this number as the index for the new link.
	//log("Here's how many links we're working with:");
	//log(linkCount);
	log("Finding the last link ID");
	// We have to find out what the ID of the last link is so that we don't overwrite any old links. 
	var lastLinkId;
	log("Starting the loop to get the last index item...");
	for (var i in linkList) {
		//log("i = ");
		//log(i);
    	//log("Last item found: ");
    	//log(linkList[i]);
    	var item = i;
    	//log("Item = ");
    	//log(item);
	}
	var newLinkId = Number(item) + Number(1);
	//log(newLinkId);
	log("Setting values for new link #" + newLinkId);
	// Let's set the values for the new link
	linkList[newLinkId] = {"href":url,"name":title};
	log(linkList[newLinkId]);
	log("Updating link count in link object..");
	// Now, let's update the link count in the Link Object
	linkObj.linkCount = linkCount + 1;
	//log(linkList);
	//log(linkObj);
	log("Now, let's store it in local storage. Fingers crossed!");
	// Now let's store it in local storage
	if(storeLinkObj(linkObj)) {
		log("New link with url " + url + " and title " + title + " successfully stored in local storage.");
		return true;
	} else {
		log("New link with url " + url + " and title " + title + " UNABLE TO BE STORED in local storage.");
		return false;
	}
}

function countTotalLinks(obj) {
	// Now let's count the links
	var count = 0;
	for(var i in obj) {
		count = count + 1;
	}
	return count;
}

function storeLinkObj(linkObj) {
	var db = parseDatabase();
	db.links = linkObj;
	log("New Full Object to be stored:");
	log(db);
	if(storeObj(db)) {
		log("StoreLinkObj: Link object successfully updated in database!");
		return true;
	} else {
		log("Unknown failure while updating links in database.");
		return false;
	}
}

function storeObj(obj) {
	log("Storing the following Link Object into local storage into table " + lsTable + ".");
	log(obj);
	var stringy = JSON.stringify(obj);
	//var thing = "Test bullshit";
	log("The database will receive this information: " + stringy);
	window.localStorage[lsTable] = stringy;
	if(true) {
		log("Link object successfully stored. I hope the new tab page updates!");
		return true;
	} else {
		log("Link object UNABLE to be stored. Whoops!");
		return false;
	}
}

function getLinkObj() {
	log("Grabbing database object...");
	var dbObj = parseDatabase();
	log(dbObj);
	var linkData = dbObj.links;
	log("GetLinkObj: LinkData: ");
	log(linkData);
	return linkData;
}

function sendObj() {
	return JSON.parse(defaultData);
}

function parseDatabase() {
	log("Parsing database...");
	// Grab everything from the local storage database and parse it
	var db = JSON.parse(window.localStorage[lsTable]);
	log(db);
	return db;
}

function processInstall() {
	log("Processing installation...");
	if(storeObj(defaultData)) {
		log("Table built!");
		return true;
	} else {
		log("Unable to build table. Please try reinstalling this extension.");
		return false;
	}
}

function isFirstInstall() {
	log("Checking for first install...");
	if(!window.localStorage[lsTable]) {
		log("First install, building table...");
		processInstall();
	} else {
		log("Not first install.");
		return false;
	}
}

function buildLinks() {
	var data = parseDatabase();
	var debug = getDeveloperMode();
	log('Working on links now...');
	var linkOutput = "";
	var links = data.links.links;
	if(debug) {
		for(var i in links) {
			log("Link #" + i + ": Name-" + links[i].name + ", href-" + links[i].href + ".");
		}
	}	
	if(links) {
		log("There are links in the database for parsing. Starting loop now.");
		for(var link in links) {
			if(links.hasOwnProperty(link)) {
				var currentLink = "<a href=\"" + links[link].href +"\" class=\"link\" id=\"" + link + "\"><h2>" + links[link].name + "</h2></a>";
				linkOutput += currentLink;
				log("Link " + link + ": " + currentLink);
			}
		}
		return linkOutput;
	} else {
		log("No links were found. Something is screwy.");
	}
}

function removeLink(id) {
	var data = parseDatabase();
	var links = data.links.links;
	console.log(links);
	//links.splice(id,1);
	console.log(id + " -- " + data.links.links[id]);
	delete data.links.links[id];
	console.log(data.links.links);
	if(storeObj(data)) {
		console.log('Link #' + id + " removed!");
		return true;
	} else {
		console.log('Unable to remove link #' + id);
		return false;
	}
}


// Google Analytics functions
function trackButton() {
    _gaq.push(['_trackEvent', 'Site added to new tab page using the "Add" button.']);
};

function trackAddBox() {
    _gaq.push(['_trackEvent', 'Site added to new tab page using the text input box in the popup.']);
};

</script>
</head>
<body>
<script>
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-21684633-1']);
_gaq.push(['_trackPageview']);

(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = 'https://ssl.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
</body>
</html>
